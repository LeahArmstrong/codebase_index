#!/usr/bin/env ruby
# frozen_string_literal: true

# MCP server for querying CodebaseIndex extraction output over HTTP.
#
# Usage:
#   codebase-index-mcp-http [INDEX_DIR]
#   CODEBASE_INDEX_DIR=/path/to/output codebase-index-mcp-http
#
# Reads JSON files from the extraction output directory and exposes
# them via the Model Context Protocol (Streamable HTTP transport).
# Requires the `rackup` gem and a Rack-compatible server (e.g., puma).

require 'rackup'
require_relative '../lib/codebase_index'
require_relative '../lib/codebase_index/dependency_graph'
require_relative '../lib/codebase_index/graph_analyzer'
require_relative '../lib/codebase_index/mcp/server'
require_relative '../lib/codebase_index/mcp/bootstrapper'
require_relative '../lib/codebase_index/embedding/text_preparer'
require_relative '../lib/codebase_index/embedding/indexer'

index_dir = CodebaseIndex::MCP::Bootstrapper.resolve_index_dir(ARGV)
retriever = CodebaseIndex::MCP::Bootstrapper.build_retriever

port = (ENV['PORT'] || 9292).to_i
host = ENV['HOST'] || 'localhost'

server = CodebaseIndex::MCP::Server.build(index_dir: index_dir, retriever: retriever)
transport = MCP::Server::Transports::StreamableHTTPTransport.new(server)
server.transport = transport

app = proc { |env| transport.handle_request(Rack::Request.new(env)) }

warn "CodebaseIndex MCP HTTP server starting on http://#{host}:#{port}"
Rackup::Handler.default.run(app, Port: port, Host: host)
