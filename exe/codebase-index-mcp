#!/usr/bin/env ruby
# frozen_string_literal: true

# MCP server for querying CodebaseIndex extraction output.
#
# Usage:
#   codebase-index-mcp [INDEX_DIR]
#   CODEBASE_INDEX_DIR=/path/to/output codebase-index-mcp
#
# Reads JSON files from the extraction output directory and exposes
# them via the Model Context Protocol (stdio transport).
# Does NOT require Rails â€” only reads pre-extracted data.

require_relative '../lib/codebase_index'
require_relative '../lib/codebase_index/dependency_graph'
require_relative '../lib/codebase_index/graph_analyzer'
require_relative '../lib/codebase_index/mcp/server'
require_relative '../lib/codebase_index/mcp/bootstrapper'
require_relative '../lib/codebase_index/embedding/text_preparer'
require_relative '../lib/codebase_index/embedding/indexer'

index_dir = CodebaseIndex::MCP::Bootstrapper.resolve_index_dir(ARGV)
retriever = CodebaseIndex::MCP::Bootstrapper.build_retriever

server = CodebaseIndex::MCP::Server.build(index_dir: index_dir, retriever: retriever)

# Pin protocol version for broad client compatibility (Claude Code, Cursor, etc.)
if ENV['MCP_PROTOCOL_VERSION']
  server.configuration = MCP::Configuration.new(protocol_version: ENV['MCP_PROTOCOL_VERSION'])
end

transport = MCP::Server::Transports::StdioTransport.new(server)
transport.open
